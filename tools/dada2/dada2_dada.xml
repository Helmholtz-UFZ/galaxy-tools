<tool id="dada2_dada" name="dada2: dada" version="@DADA2_VERSION@">
    <description>Remove sequencing errors</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <exmand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
    #if $batch_cond.batch_select == "no"	
        #for $d in $batch_cond.derep:
            ln -s '$d' '$d.element_identifier' &&
        #end for
    #else
        ln -s '$batch_cond.derep.extra_files_path'/Rdata '$batch_cond.derep.element_identifier' &&
    #end if
	mkdir '$dada.extra_files_path' &&
	Rscript '$dada2_script' \${GALAXY_SLOTS:-1}
    ]]></command>
    <configfiles>
        <configfile name="dada2_script"><![CDATA[
library(ggplot2, quietly=T)
library(dada2, quietly=T)

args <- commandArgs(trailingOnly = TRUE)
nthreads <- args[1]

#if $batch_cond.batch_select == "no"	
derep <- list()
    #for $d in $batch_cond.derep:
derep[[length(derep)+1]] <- readRDS('$d.element_identifier')
    #end for
#else
derep <- readRDS('$batch_cond.derep.element_identifier')
#end if

err <- readRDS(file.path('$errorrates.extra_files_path',"Rdata"))

dada_result <- dada(derep, err, errorEstimationFunction = $errfoo, selfConsist = $selfconsist, pool = $batch_cond.pool, multithread = nthreads)

write.table(dada_result\$clustering, file = '$dada', quote = F, sep = "\t", row.names = F, col.names = F)
saveRDS(dada_result, file=file.path('$dada.extra_files_path',"Rdata"))

    ]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="batch_cond">
            <param name="batch_select" type="select" label="Process samples in batches">
                <option value="yes">yes</option>
                <option value="no">no</option>
            </param>
            <when value="yes">
                <param name="derep" type="data" format="dada2.derep" label="Dereplicated reads"/>
                <param name="pool" type="text" value="FALSE" hidden="true" label="Pool samples"/>
            </when>
            <when value="no">
                <param name="derep" type="data" multiple="true" format="dada2.derep" label="Dereplicated reads"/>
                <param name="pool" type="select" label="Pool samples">
                    <option value="FALSE">process samples individually</option>
                    <option value="TRUE">pool samples</option>
                    <option value="'pseudo'">pseudo pooling between individually processed samples</option>
                </param>
            </when>
        </conditional>
        <param name="errorrates" type="data" format="dada2.errorrates" label="Error rates"/>
        <expand macro="errorEstimationFunction"/>
        <param name="selfconsist" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="Alternate between sample inference and error rate estimation until convergence"/>
    </inputs>
    <outputs>
        <data name="dada" format="dada2.dada" label="${tool.name} on ${on_string}"/>
    </outputs>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
    <expand macro="citations"/>
</tool>
