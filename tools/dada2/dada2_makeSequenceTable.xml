<tool id="dada2_makeSequenceTable" name="dada2: makeSequenceTable" version="@DADA2_VERSION@+galaxy@WRAPPER_VERSION@">
    <description>construct a sequence table (analogous to OTU table)</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
    Rscript '$dada2_script'
    ]]></command>
    <configfiles>
        <configfile name="dada2_script"><![CDATA[
@READ_FOO@

library(dada2, quietly=T)
#if $plot == "yes"
library(ggplot2, quietly=T)
#end if

samples <- list()
#for $s in $samples:
    #if $len($samples) == 1
    samples <- $read_data($s)
    #else
    samples[["$s.element_identifier"]] <- $read_data($s)
    #end if
#end for
## make sequence table
seqtab <- makeSequenceTable(samples, orderBy = "$orderby")


## get and plot length distribution
#if $plot == "yes" or $filter_cond.filter_select == "minmax" != "no":

seqlen<-c()
for( c in 1:ncol(seqtab) ){
    for( r in 1:nrow(seqtab) ){
        seqlen <- c(seqlen, rep(nchar( colnames(seqtab)[c] ), seqtab[ r, c ]))
    }
}
TODO https://github.com/benjjneb/dada2/issues/704#issuecomment-471577398
#if $filter_cond.filter_select == "minmax": 
    rng <- c($filter_cond.min,$filter_cond.max)
    outliers <-unique(sort( seqlen[ ! seqlen %in% seq() ] ))
#else
    #if $filter_cond.filter_select == "no":
       coef <- 1.5
    #else
       coef <- $filter_cond.coef
    #end if
    rng <- range( seqlen[ ! seqlen %in% boxplot.stats(seqlen, coef=coef)\$out ] )
#end if

#if $plot == "yes"
pdf( '$plot_output' )
D <- data.frame(length=seqlen )
ggplot(D) + 
    geom_histogram( aes(x=length), binwidth=1 ) + 
    geom_vline( xintercept=c(rng[1]-0.5, rng[2]+0.5) ) + 
    theme_bw()
bequiet <- dev.off()
#end if

## filter by seqlengths
#if $filter_cond.filter_select != "no"
    seqtab <- seqtab[, nchar(colnames(seqtab)) %in% seq(rng[1], rng[2])]
#end if
#end if

write.table(seqtab, "$stable", quote=F, sep="\t", row.names = T, col.names = NA)
    ]]></configfile>
    </configfiles>
    <inputs>
        <param name="samples" type="data" multiple="true" format="@DADA_UNIQUES@" label="samples" />
        <param name="orderby" type="select" label="Column order">
            <option value="abundance">abundance</option>
            <option value="nsamples">nsamples</option>
        </param>
        <conditional name="filter_cond">
            <param name="filter_select" type="select" label="Filter method">
                <option value="no">No filter</option>
                <option value="minmax">Specify minimum and maximum sequence lengths</option>
                <option value="outlier">Automatic by outlier detection</option>
            </param>
            <when value="no"/>
            <when value="minmax">
                <param name="min" type="integer" value="" label="Minimum sequence length"/>
                <param name="max" type="integer" value="" label="Maximum sequence length"/>
            </when>
            <when value="outlier">
                <param name="coef" type="float" value="1.5" label="Interquartile range coefficient"/>
            </when>
        </conditional>
        <param name="plot" type="boolean" truevalue="yes" falsevalue="no" checked="true" label="plot sequence length distribution" />
    </inputs>
    <outputs>
        <data name="stable" format="dada2_sequencetable" label="${tool.name} on ${on_string}"/>
        <data name="plot_output" format="pdf" label="${tool.name} on ${on_string}: sequence length distribution">
            <filter>plot</filter>
        </data>
    </outputs>

    <help><![CDATA[
This function constructs a sequence table (analogous to an OTU table) from the provided list of
samples.

Custom Reference data sets
--------------------------

For ** taxonomy assignment ** the following is needed: 

- a reference fasta data base 
- a comma separated list of taxonomic ranks present in the reference data base 

The reference fasta data base for taxonomic assignment (fasta or compressed fasta) needs to encode the taxonomy corresponding to each sequence in the fasta header lines in the following fashion (note, the second sequence is not assigned down to level 6):

::

    >Level1;Level2;Level3;Level4;Level5;Level6;
    ACCTAGAAAGTCGTAGATCGAAGTTGAAGCATCGCCCGATGATCGTCTGAAGCTGTAGCATGAGTCGATTTTCACATTCAGGGATACCATAGGATAC
    >Level1;Level2;Level3;Level4;Level5;
    CGCTAGAAAGTCGTAGAAGGCTCGGAGGTTTGAAGCATCGCCCGATGGGATCTCGTTGCTGTAGCATGAGTACGGACATTCAGGGATCATAGGATAC

The list of required taxonomic ranks could be for instance: "Kingdom,Phylum,Class,Order,Family,Genus"

The reference data base for ** species assignment ** is a fasta file (or compressed fasta file), with the id line formatted as follows:

::

    >ID Genus species
    ACCTAGAAAGTCGTAGATCGAAGTTGAAGCATCGCCCGATGATCGTCTGAAGCTGTAGCATGAGTCGATTTTCACATTCAGGGATACCATAGGATAC
    >ID Genus species
    CGCTAGAAAGTCGTAGAAGGCTCGGAGGTTTGAAGCATCGCCCGATGGGATCTCGTTGCTGTAGCATGAGTACGGACATTCAGGGATCATAGGATAC
    ]]></help>
    <expand macro="citations"/>
</tool>
