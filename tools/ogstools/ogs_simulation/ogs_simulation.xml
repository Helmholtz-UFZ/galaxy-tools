<tool id="ogs_simulation" name="ogstools_ogs_simulation" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>
        Runs an OGS simulation.
    </description>
    <macros>
        <import>macros.xml</import>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <requirements>
        <expand macro="ogs_requirement"/>
        <requirement type="package" version=">=2.13.6">pybind11</requirement> 
        <requirement type="package" version=">=1.2.5">tclap</requirement>
        <requirement type="package" version=">=2.2.0rc1">numpy</requirement>
    </requirements>        
    <command detect_errors="exit_code"><![CDATA[            TODO Output directory lÃ¶schen??
        ogs 
        --project-file '${project_file}' 
        --output-directory '${output_directory}' 
        #if $log_level: 
        --log-level '${log_level}' 
        #end if 
        #if $enable_fpe:
        --enable-fpe 
        #end if
        unbuffered_cout_arg      
        #if $xml_patch_files: 
        --xml-patch "${xml_patch_files}" 
        #end if 
        --write-prj
        config-warnings-nonfatal
        
        
    ]]></command>
    <inputs>
        <param name="project_file" format="prj" type="data" label="Project File (.prj)"/>
        <param name="output_directory" type="text" label="Output Directory" value="./output"/>
        <param name="log_level" type="select" label="Log Level" optional="true">
            <option value="none">None</option>
            <option value="error">Error</option>
            <option value="warn">Warning</option>
            <option value="info" selected="true">Info</option>
            <option value="debug">Debug</option>
            <option value="all">All</option>
        </param>
        <param name="enable_fpe" type="boolean" optional="true"/>
        <param name="unbuffered_cout_arg" type="boolean"  optional="true" argument="--unbuffered-std-out"/>
        
        <param name="xml_patch_files" type="data" format="xml" label="XML Patch Files" optional="true" multiple="true"/>
        <param name="config_warnings_nonfatal" type="boolean"/>
    </inputs>
    <outputs>
    <data name="log_file" format="txt" label="Simulation Log" />
        <data name="simulation_results" format="collection" label="Simulation Results">
            <discover_datasets pattern="__output_directory__/.*\.vtu" directory="output_directory" visible="true" />
        </data>
    </outputs>
    <tests>
    <test>
        <param name="project_file" value="test_project.prj" />
        <param name="output_directory" value="./test_output" />
        <param name="log_level" value="info" />
        <param name="enable_fpe" value="true" />
        <param name="config_warnings_nonfatal" value="true" />

        <output name="log_file" file="test_output/simulation.log" />
        <output_collection name="simulation_results">
            <element name="result1" file="test_output/result1.vtu" />
            <element name="result2" file="test_output/result2.vtu" />
        </output_collection>
    </test>
</tests>

    <help><![CDATA[
        **Overview:**

            This tool runs an OpenGeoSys (OGS) simulation with support for Python boundary conditions and enhanced CLI argument parsing. The simulation uses a project file and optional XML patch files to define and adjust simulation parameters dynamically.

        **Inputs:**

            1. **Project File:** The main project file (.prj) that defines the simulation setup.
            2. **Output Directory:** The directory where the simulation results and logs will be saved. Default is `./output`.
            3. **Log Level:** Sets the verbosity of logs. Options include `none`, `error`, `warn`, `info` (default), `debug`, and `all`.
            4. **XML Patch Files:** Optional XML files for modifying the project file configuration at runtime.
            5. **Enable Floating Point Exceptions:** Enables detection of floating-point exceptions (only for non-Windows platforms).

        **Outputs:**

            1. **Log File:** Contains all log messages generated during the simulation.
            2. **Simulation Results:** Includes output files such as VTU and other simulation results saved in the specified output directory.
    ]]></help>
    <expand macro="ogs_citation"/>
</tool>