<tool id="proteomicsr_fc_workflow" name="proteomicsr: FC workflow" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$rscript'
    ]]></command>
    <configfiles>
        <configfile name="rscript"><![CDATA[
library(proteomicsr)

#if $sampleTable.ext == 'csv'
    sampleTable <- read.csv("$sampleTable", row.names = 1)
#else
    sampleTable <- read.delim("$sampleTable", header = TRUE, row.names = 1, sep = "\t")
#end if
run_FC_workflow(
    sampleTable,
    sampleGenes = NULL,
    sampleMapping = NULL,
    remove_outliers = $remove_outliers,
    median_normalize = $median_normalize,
    number_replicates_reliable = $number_replicates_reliable,
    reliable_all_comparisons = $reliable_all_comparisons,
    alternative = "$alternative",
    var.equal = $var_equal,
    paired = $paired,
    ## this only decides the output and column name should be hardcoded here?
    pvalue_decision = "pvalue.adj",
    pvalue_adjustment = "$pvalue_adjustment",
    significance_cutoff = $significance_cutoff,
    color_up = "${color_up}FF",
    color_none = "${color_none}FF",
    color_down = "${color_down}FF"
)
        ]]></configfile>
    </configfiles>
    <inputs>
        <param argument="sampleTable" type="data" format="csv,tabular" label="Sample table" help="Rows: unique identifiers (e.g. uniprot accessions), Columns: samples. Replicates should be indicated using _1, _2, .... Content should be numeric."/>
<!--
    TODO Missing pipeline description
    TODO Structure parameters with sections?
    TODO Missing: description of outputs

@param sampleGenes A dataframe containing mapping of Accessions, which should be the rownames, and corresponding gene names, which should be stored in a column named Gene. Default: NULL. Thus, no accession-gene mapping is performed.
@param sampleMapping A dataframe, which can be used to relate different conditions to ggplot facets. The treatments, which should also appear in the sampleTable, have to be the rownames. The following columns should be present:
"Xname" (the sample name, which will be shown on the X-axis),
"Order" (numbers indicating the preferred order of the treatments/comparisons on the X-axis - from left to right),
Condition1 (character, which will be used for the first level ggplot facet),
Condition2 (character, which will be used for the second level ggplot facet).
If no sampleMapping dataframe is available, use sampleMapping = NULL, which is also the default.
-->
        <param argument="remove_outliers" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Remove outliers" help="Identified by the function identify_outliers() based on Mahalanobis distances"/>
        <param argument="median_normalize" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Apply median normalization" help=""/>
        <param argument="number_replicates_reliable" type="integer" min="1" value="3" label="Number of replicates for reliable identification" help="Number of replicates for which quantitation data should be available to consider a protein reliably identified under the particular condition (i.e. in a sample)"/>
        <!--TODO formulation unclear, comparisons between what? Samples? -->
        <param argument="reliable_all_comparisons" type="select" label="Required comparisons" help="Proteins are returned that are identified in the given number of replicates (number_replicates_reliable) in all/at least one comparison.">
            <option value="FALSE">At least one</option>
            <option value="TRUE">All</option>
        </param>
        <!-- TODO which variances? -->
        <param argument="var.equal" name="var_equal" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true" label="Treat variances as equal" help="for t-test"/>
        <!-- <section title="test" name="test"> -->
        <param argument="paired" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true" label="Use paired t-test" help=""/>
        <param argument="alternative" type="select" label="Alternative hypothesis" help="">
            <option value="two.sided">two.sided</option>
            <option value="greater">greater</option>
            <option value="less">less</option>
        </param>
        <param argument="pvalue_adjustment" type="select" label="Method for p-value adjustment" help="">
            <option value="holm">Holm</option>
            <option value="hochberg">Hochberg</option>
            <option value="hommel">Hommel</option>
            <option value="bonferroni">Bonferroni</option>
            <option value="BY">Benjamini &amp; Yekutieli (BY)</option>
            <option value="fdr" selected="true">Benjamini &amp; Hochberg (BH/fdr)</option>
            <option value="none">None</option>
        </param>
        <param argument="significance_cutoff" type="float" value="0.05" min="0" max="1" label="Significance cutoff" help="All proteins with lower value are considered significantly affected"/>
        <!-- </section> -->
        <param argument="color_up" type="color" value="#DC0000" label="Color for up-regulated proteins"/>
        <param argument="color_down" type="color" value="#3C5488" label="Color for down-regulated proteins"/>
        <param argument="color_none" type="color" value="#000000" label="Color for insignificant differential expression"/>
        <param name="out_select" type="select" multiple="true">
            <option value="dat_calcuated">dat calculated TODO</option>
            <option value="plots" selected="true">Plots</option>
        </param>
    </inputs>
    <outputs>
        <!-- TODO make dat_calculated primary output -->
        <!-- <data name="log"/> -->
        <data name="dat_calculated" format="csv" from_work_dir="Rdata/dat_calculated.csv">
            <filter>"dat_calculated" in out_select</filter>
        </data>
        <collection name="output" type="list">
            <discover_datasets pattern="__name_and_ext__" directory="Rdata"/>
        </collection>
        <collection name="plots" type="list" label="${tool.name} on ${on_string}: plots">
            <discover_datasets pattern="__name_and_ext__" directory="Plots"/>
            <filter>"plots" in out_selected</filter>
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="sampleTable" value="sampleTable.csv" ftype="csv"/>
            <output_collection name="output" count="3" type="list">
                <!-- TODO there should be more outputs -->
                <element name="dat_log2" ftype="csv">
                    <assert_contents>
                        <has_n_lines n="5058"/>
                        <has_n_columns sep="," n="25"/>
                    </assert_contents>
                </element>
                <element name="dat_reliable" ftype="csv">
                    <assert_contents>
                        <has_n_lines n="4269"/>
                        <has_n_columns sep="," n="16"/>
                    </assert_contents>
                </element>
                <element name="Mahalanobis_Outliers.csv" ftype="csv">
                    <assert_contents>
                        <has_n_lines n="25"/>
                        <has_n_columns sep="," n="3"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
</tool>