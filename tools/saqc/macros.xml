<macros>

<xml name="requirements">
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">saqc</requirement>
    </requirements>
</xml>

<token name="@TOOL_VERSION@">2.6.0</token>
<token name="@VERSION_SUFFIX@">0</token>

<xml name="citations">
    <citations>
        <citation type="doi">https://doi.org/10.1016/j.envsoft.2023.105809</citation>
    </citations>
</xml>

<xml name="field">
    <param argument="field"
           label="Field"
           optional="false"
           value=""
           type="text"
           help="Variable to process"/>
</xml>

<xml name="field_multiple">
    <repeat name="field_repeat" title="field(s)" min="1">
        <param argument="field"
               label="Field"
               optional="false"
               value=""
               type="text"
               help="Variable to process"/>
    </repeat>
</xml>

<xml name="flag">
    <param argument="flag"
           label="Flag"
           optional="true"
           value="255.0"
           type="float"
           help="The flag value the function uses to mark observations"/>
</xml>

<xml name="saqc_tests">
<tests>
    <test>
        <param name="data" value="test1/data.csv" ftype="csv"/>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="outliers"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagRange"/>
                    <param name="field" value="SM2"/>
                    <param name="min" value="10.0"/>
                    <param name="max" value="60.0"/>
                    <param name="flag" value="255.0"/>
                </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="outliers"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagMAD"/>
                    <param name="field" value="SM2"/>
                    <param name="center" value="false"/>
                    <conditional name="window_cond">
                        <param name="window_select_type" value="timedelta"/>
                        <param name="window" value="30d"/>
                    </conditional>
                    <param name="z" value="3.5"/>
                    <param name="min_periods" value=""/>
                    <param name="min_residuals" value=""/>
                    <param name="flag" value="255.0"/>
                </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="tools"/>
                <conditional name="method_cond">
                    <param name="method_select" value="plot"/>
                    <param name="field" value="SM2"/>
                    <param name="path" value="test"/>
                    <conditional name="history_cond">
                        <param name="history_select_type" value="valid" />
                        <param name="history" value="valid" />
                    </conditional>
                    <param name="mode" value="oneplot"/>
                    <param name="max_gap" value="" />
                    <param name="xscope" value="" />
                    <param name="yscope" value="" />
                    <param name="marker_kwargs" value="" />
                    <param name="plot_kwargs" value="" />
                    <param name="dfilter" value="inf" />
                </conditional>
            </conditional>
        </repeat>

        <output name="output" file="test1/out.csv" ftype="csv"> 
            <assert_contents>
                <has_n_lines n="200" />
                <has_n_columns n="6" sep=","/>
                <has_line_matching expression=",Battery,Battery,SM1,SM1,SM2,SM2" />
                <has_line_matching expression=",data,flags,data,flags,data,flags" />
                <has_line_matching expression="2016-04-01 00:00:00,nan,nan,nan,nan,29.3157,UNFLAGGED" />  
            </assert_contents>
        </output>
        <output name="config_out" ftype="txt">
            <assert_contents>
                <has_n_lines n="6"/>
                <has_n_columns n="2" sep=";"/>
                <has_line_matching expression="SM2        ; align(freq=&apos;15Min&apos;, method=&apos;nshift&apos;)" />
                
            </assert_contents>
        </output>
        <output_collection name="plots" type="list">
            <element name="test" ftype="png">
                <assert_contents>
                    <has_text text="PNG"/>
                    <has_size value="120k" delta="30k"/>
                </assert_contents>
            </element>
        </output_collection>
    </test>

    <test>
        <param name="data" value="test2/data.csv,test2/maint.csv" ftype="csv"/>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="flagtools"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagManual"/>
                    <param name="field" value="sac254_raw"/>
                    <param name="mdata" value="maint"/>
                    <param name="method" value="closed"/>
                    <param name="mformat" value="start-end"/>
                    <param name="flag" value="255.0"/>
                </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="outliers"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagRange"/>
                    <param name="field" value="sac254_raw"/>
                    <param name="min" value="1.0"/>
                    <param name="max" value="200.0"/>
                    <param name="flag" value="255.0"/>
                 </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="constants"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagConstants"/>
                    <param name="field" value="sac254_raw"/>
                    <param name="thresh" value="0.0"/>
                    <param name="window" value="4h"/>
                    <param name="min_periods" value="2"/>
                    <param name="flag" value="255.0"/>
                 </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="outliers"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagUniLOF"/>
                    <param name="field" value="sac254_raw"/>
                    <conditional name="thresh_cond">
                        <param name="thresh_select_type" value="float"/>
                        <param name="thresh" value="2.2"/>
                    </conditional>
                    <param name="algorithm" value="ball_tree"/>
                    <param name="n" value="20"/>
                    <param name="p" value="1"/>
                    <conditional name="density_cond">
                        <param name="density_select_type" value="auto"/>
                        <param name="density" value="auto"/>
                    </conditional>
                    <param name="fill_na" value="true"/>
                    <param name="slope_correct" value="true"/>
                    <param name="min_offset" value=""/>
                    <param name="flag" value="255.0"/>
                 </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="breaks"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagIsolated"/>
                    <param name="field" value="sac254_raw"/>
                    <param name="gap_window" value="30min"/>
                    <param name="group_window" value="1h"/>
                    <param name="flag" value="255.0"/>
                </conditional>
            </conditional>
        </repeat>

        <output name="output" file="test2/out.csv" ftype="csv"> <assert_contents>
                <has_n_lines n="138" /> 
                <has_n_columns n="18" sep=","/>
                <has_line_matching expression=",sac254_raw,sac254_raw,level_raw,level_raw,water_temp_raw,water_temp_raw,maint,maint,sac254_corr,sac254_corr,level_z,level_z,water_z,water_z,sac_z,sac_z,kNN_scores,kNN_scores" />
                <has_line_matching expression=",data,flags,data,flags,data,flags,data,flags,data,flags,data,flags,data,flags,data,flags,data,flags" />
                <has_line_matching expression="2016-01-01 00:15:00,18.617873333333332,UNFLAGGED,103.28566666666667,UNFLAGGED,4.822666666666667,UNFLAGGED,nan,nan,18.617873333333332,UNFLAGGED,-0.6275888145515292,UNFLAGGED,2.5799063966804945,UNFLAGGED,-0.24835023991514574,UNFLAGGED,8.624787213183476,UNFLAGGED" />
                

            </assert_contents>
        </output>
        <output name="config_out" ftype="txt">
            <assert_contents>
                <has_n_lines n="21"/>
                <has_n_columns n="2" sep=";"/>
                <has_line_matching expression="sac254_raw              ; flagManual(mdata='maint', method='closed')"/>
            </assert_contents>
        </output>
    </test>
</tests>
</xml>
</macros>