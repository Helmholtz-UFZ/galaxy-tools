<macros>

<xml name="requirements">
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">saqc</requirement>
    </requirements>
</xml>

<token name="@TOOL_VERSION@">2.6.0</token>
<token name="@VERSION_SUFFIX@">0</token>

<xml name="citations">
    <citations>
        <citation type="doi">https://doi.org/10.1016/j.envsoft.2023.105809</citation>
    </citations>
</xml>

<xml name="field">
    <param argument="field"
           label="Field"
           optional="false"
           value=""
           type="text"
           help="Variable to process"/>
</xml>

<xml name="field_multiple">
    <repeat name="field_repeat" title="field(s)" min="1">
        <param argument="field"
               label="Field"
               optional="false"
               value=""
               type="text"
               help="Variable to process"/>
    </repeat>
</xml>

<xml name="flag">
    <param argument="flag"
           label="Flag"
           optional="true"
           value="255.0"
           type="float"
           help="The flag value the function uses to mark observations"/>
</xml>

<xml name="saqc_tests">
<tests>
    <test>
        <param name="data" value="test1/data.csv" ftype="csv"/>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="outliers"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagRange"/>
                    <param name="field" value="SM2"/>
                    <param name="min" value="10.0"/>
                    <param name="max" value="60.0"/>
                    <param name="flag" value="255.0"/>
                </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="outliers"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagMAD"/>
                    <param name="field" value="SM2"/>
                    <param name="center" value="false"/>
                    <conditional name="window_cond">
                        <param name="window_select_type" value="timedelta"/>
                        <param name="window" value="30d"/>
                    </conditional>
                    <param name="z" value="3.5"/>
                    <param name="min_periods" value=""/>
                    <param name="min_residuals" value=""/>
                    <param name="flag" value="255.0"/>
                </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="tools"/>
                <conditional name="method_cond">
                    <param name="method_select" value="plot"/>
                    <param name="field" value="SM2"/>
                    <param name="path" value="test"/>
                    <conditional name="history_cond">
                        <param name="history_select_type" value="valid" />
                        <param name="history" value="valid" />
                    </conditional>
                    <param name="mode" value="oneplot"/>
                    <param name="max_gap" value="" />
                    <param name="xscope" value="" />
                    <param name="yscope" value="" />
                    <param name="marker_kwargs" value="" />
                    <param name="plot_kwargs" value="" />
                    <param name="dfilter" value="inf" />
                </conditional>
            </conditional>
        </repeat>
        <output name="output" file="test1/out.csv" ftype="csv" compare="diff" lines_diff="6"/>
        <output name="config_out" ftype="txt">
            <assert_contents>
                <has_n_lines n="4"/>
                <has_n_columns n="2" sep=";"/>
                <has_line_matching expression="SM2; flagMAD\(center=False, flag=255.0, min_periods=None, min_residuals=None, window=&quot;30d&quot;, z=3.5\)" />
                <has_line_matching expression="SM2; flagRange\(flag=255.0, max=60.0, min=10.0\)" />
                <has_line_matching expression='SM2; plot\(dfilter=float\(&apos;inf&apos;\), history="valid", marker_kwargs=None, max_gap=None, mode="oneplot", path="test", plot_kwargs=None, xscope=None, yscope=None\)' />
            </assert_contents>
        </output>
        <output_collection name="plots" type="list">
            <element name="test" ftype="png">
                <assert_contents>
                    <has_text text="PNG"/>
                    <has_size value="120k" delta="30k"/>
                </assert_contents>
            </element>
        </output_collection>
    </test>

    <test>
        <param name="data" value="test2/data.csv,test2/maint.csv" ftype="csv"/>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="flagtools"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagManual"/>
                    <param name="field" value="sac254_raw"/>
                    <param name="mdata" value="maint"/>
                    <param name="method" value="closed"/>
                    <param name="mformat" value="start-end"/>
                    <param name="flag" value="255.0"/>
                </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="outliers"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagRange"/>
                    <param name="field" value="sac254_raw"/>
                    <param name="min" value="1.0"/>
                    <param name="max" value="200.0"/>
                    <param name="flag" value="255.0"/>
                 </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="constants"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagConstants"/>
                    <param name="field" value="sac254_raw"/>
                    <param name="thresh" value="0.0"/>
                    <param name="window" value="4h"/>
                    <param name="min_periods" value="2"/>
                    <param name="flag" value="255.0"/>
                 </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="outliers"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagUniLOF"/>
                    <param name="field" value="sac254_raw"/>
                    <conditional name="thresh_cond">
                        <param name="thresh_select_type" value="float"/>
                        <param name="thresh" value="2.2"/>
                    </conditional>
                    <param name="algorithm" value="ball_tree"/>
                    <param name="n" value="20"/>
                    <param name="p" value="1"/>
                    <conditional name="density_cond">
                        <param name="density_select_type" value="auto"/>
                        <param name="density" value="auto"/>
                    </conditional>
                    <param name="fill_na" value="true"/>
                    <param name="slope_correct" value="true"/>
                    <param name="min_offset" value=""/>
                    <param name="flag" value="255.0"/>
                 </conditional>
            </conditional>
        </repeat>
        <repeat name="methods_repeat">
            <conditional name="module_cond">
                <param name="module_select" value="breaks"/>
                <conditional name="method_cond">
                    <param name="method_select" value="flagIsolated"/>
                    <param name="field" value="sac254_raw"/>
                    <param name="gap_window" value="30min"/>
                    <param name="group_window" value="1h"/>
                    <param name="flag" value="255.0"/>
                </conditional>
            </conditional>
        </repeat>
        <output name="config_out" ftype="txt">
            <assert_contents>
                <has_n_lines n="6"/>
                <has_n_columns n="2" sep=";"/>
                <has_line_matching expression='sac254_raw; flagConstants\(flag=255.0, min_periods=2, thresh=0.0, window="4h"\)'/>
                <has_line_matching expression='sac254_raw; flagIsolated\(flag=255.0, gap_window="30min", group_window="1h"\)'/>
                <has_line_matching expression='sac254_raw; flagManual\(flag=255.0, mdata="maint", method="closed", mformat="start-end"\)'/>
                <has_line_matching expression='sac254_raw; flagRange\(flag=255.0, max=200.0, min=1.0\)'/>
                <has_line_matching expression='sac254_raw; flagUniLOF\(algorithm="ball_tree", density="auto", fill_na=True, flag=255.0, min_offset=None, n=20, p=1, slope_correct=True, thresh=2.2\)'/>
            </assert_contents>
        </output>
        <output name="output" file="test2/out.csv" ftype="csv" compare="diff" lines_diff="6"/>
    </test>
</tests>
</xml>
</macros>