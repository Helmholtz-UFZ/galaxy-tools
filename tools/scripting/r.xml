<tool id="r_tidyverse" name="@LANGUAGE@" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="23.0">
    <description>tidyverse</description>
    <macros>
        <import>macros.xml</import>
        <token name="@LANGUAGE@">R</token>
        <token name="@CONTAINER@">rocker/tidyverse</token>
        <token name="@TOOL_VERSION@">4.3.1</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <token name="@COMMAND_AND_SETUP@"><![CDATA[
            ## The following is disabled, because it would allow the installation of R packages
            ## which I do not want (because users likely would install unversioned tools)
            ## echo ".libPaths(c(\"\${R_LIBS_USER:-\$_GALAXY_JOB_TMP_DIR}\", \"/usr/local/lib/R/site-library\", \"/usr/local/lib/R/library\"))" > ~/.Rprofile &&
            Rscript
        ]]></token>
        <token name="@HELP_PARAMETERS@"><![CDATA[
In the R script parameters can be used as follows, e.g.  
            
::

    args <- commandArgs(trailingOnly = TRUE);
    first_arg <- file(args[1])

the first argument will be stored in the variable `first_arg`.
        ]]></token>
        <token name="@HELP_READ_FROM_STDIN@"><![CDATA[
Dataset arguments can be read as follows, e.g. 
a tab delimited file can be read as 

::

    args <- commandArgs(trailingOnly = TRUE);
    data <- read.delim(args[1]);

        ]]></token>
    </macros>
    <xrefs>
        <xref type="bio.tools">r</xref>
    </xrefs>
    <requirements>
        <container type="docker">@CONTAINER@:@TOOL_VERSION@</container>
    </requirements>
    <version_command>R --version</version_command>
    <expand macro="command_macro"/> 
    <expand macro="inputs_macro"/>
    <expand macro="outputs_macro"/>

    <tests>
        <!-- read tsv write csv -->
        <test>
            <repeat name="parameters">
                <conditional name="type_cond">
                    <param name="param" value="test.tsv" ftype="tabular"/>
                </conditional>
            </repeat>
            <param name="code" value='args = commandArgs(trailingOnly = TRUE); data = read.delim(args[1]); write.csv(data, "data.csv", row.names=FALSE)'/>
            <output_collection name="output" type="list" count="1">
                <element name="data" ftype="csv">
                    <assert_contents>
                        <has_line line="1,2" />
                        <has_n_lines n="3"/>
                        <has_n_columns n="2" sep=","/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- use a tidyverse library -->
        <test>
            <repeat name="parameters">
                <conditional name="type_cond">
                    <param name="param" value="test.tsv" ftype="tabular"/>
                    <param name="filename" value="custom_name.tsv"/>
                </conditional>
            </repeat>
            <param name="code" value='library(ggplot2); args = commandArgs(trailingOnly = TRUE); data = read.delim(args[1]); pdf("points.pdf"); ggplot(data, aes(x=A, y=B)) + geom_point(); dev.off(); print(paste("plotted", args[1]))'/>
            <output_collection name="output" type="list" count="1">
                <element name="points" ftype="pdf">
                    <assert_contents>
                        <has_text text="PDF" />
                    </assert_contents>
                </element>
            </output_collection>
            <assert_stdout>
                <has_line line='[1] "plotted inputs/custom_name.tsv"'/>
            </assert_stdout>
        </test>
        <!-- install libraries fails -->
        <test expect_failure="true">
            <param name="code" value='install.packages("maybe"); library(maybe); print("success")'/>
        </test>
        <test expect_failure="true">
            <param name="code" value='install.packages("BiocManager"); BiocManager::install("multtest"); print("success")'/>
        </test>
        <!-- read binary files (eg rds) -->
        <test>
            <repeat name="parameters">
                <conditional name="type_cond">
                    <param name="param" value="test.rds" ftype="rds"/>
                </conditional>
            </repeat>
            <param name="code" value='args = commandArgs(trailingOnly = TRUE); data = readRDS(args[1]); write.csv(data, "data.csv", row.names=FALSE)'/>
            <output_collection name="output" type="list" count="1">
                <element name="data" ftype="csv">
                    <assert_contents>
                        <has_line line="1,2" />
                        <has_n_lines n="3"/>
                        <has_n_columns n="2" sep=","/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- optional input and parameters -->
        <test>
            <repeat name="parameters">
                <conditional name="type_cond"> 
                    <param name="type_sel" value="text"/>
                    <param name="param" value="filename.csv"/>
                </conditional>
            </repeat>
            <repeat name="parameters">
                <conditional name="type_cond"> 
                    <param name="type_sel" value="text"/>
                    <param name="param" value="some value"/>
                </conditional>
            </repeat>
            <param name="code" value='args = commandArgs(trailingOnly = TRUE); fileConn = file(args[1]); writeLines(c("Hello,world","Bye,world"), fileConn); close(fileConn); print(args[2]);'/>
            <output_collection name="output" type="list" count="1">
                <element name="filename" ftype="csv">
                    <assert_contents>
                        <has_line line="Hello,world"/>
                        <has_n_lines n="2"/>
                        <has_n_columns n="2" sep=","/>
                    </assert_contents>
                </element>
            </output_collection>
            <assert_stdout>
                <has_line line='[1] "some value"'/>
            </assert_stdout>
        </test>
    </tests>
    <expand macro="help_macro"/>
    <citations>
        <citation type="doi">10.21105/joss.01686</citation>
    </citations>
</tool>
